<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>justchart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <style>
      td {
        padding-right: 1em;
      }
    </style>
  </head>
  <body>
    <div class="container section">
      <h1 class="title is-1">Just chart!</h1>
      <p id="selected-file">Below you can see an example computed with a random sample of data, with time (x) and value (y).</p>

      <div class="container">
        <!-- <p>Or drop your JSON here!</p> -->
        <div class="section">
          <label for="file">File (.json)</label>
          <input name="file" id="file" type="file">
        </div>
      </div>

      <div>
        <h2 class="title is-4">Chart</h2>
        <div id="dataset-chart"></div>
      </div>
      <br>
      <br>
      <div class="columns">
        <div class="column">
          <h2 class="title is-4">Raw</h2>
          <i>Psst! You can edit the raw JSON</i>
          <br>
          <br>
          <div class="content">
            <span class="tag is-success" id="json-valid">valid</span>
            <span class="tag is-danger" id="json-invalid" style="display: none">invalid</span>
            <textarea class="textarea" columns="200" rows="30" editable onkeyup="onDataChanged(event)" id="dataset-raw"></textarea>
          </div>
        </div>
        <div class="column">
          <h2 class="title is-4">Formatted</h2>
          <br>
          <br>
          <div id="dataset" class="card">
            <table id="dataset-table" class="table has-text-centered">
            </table>
          </div>
        </div>
      </div>

      <footer class="footer">
        <h1 class="title is-1">About</h1>
        <p>i needed a way to visualize sample data sets in the given format:</p>

        <pre>
          [
            [
              &lt;time&gt;,
              &lt;value&gt;,
            ]
          ]
        </pre>

        With this small tool you can easily get an overview of the dataset, and even change it on the fly!
        Let me know what you think on twitter <a href="https://twitter.com/christian_fei">@christian_fei</a>
      </footer>
    </div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      const tableEl = document.getElementById('dataset-table')
      const datasetEl = document.getElementById('dataset-raw')
      const chartEl = document.getElementById('dataset-chart')
      const selectedFileEl = document.getElementById('selected-file')
      const xEl = document.getElementById('json-valid')
      const yEl = document.getElementById('json-invalid')
      document.getElementById('file').addEventListener('change', handleFileSelect, false);

      google.charts.load('current', {packages: ['corechart', 'line', 'annotationchart']})
      google.charts.setOnLoadCallback(draw => drawData(getSamples()))

      function onDataChanged (event) {
        try {
          json = JSON.parse(datasetEl.value)
          drawData(json)
          if (xEl && xEl.style) xEl.style.display = 'inline-block'
          if (yEl && yEl.style) yEl.style.display = 'none'
        } catch (err) {
          console.error(err)
          if (xEl && xEl.style) xEl.style.display = 'none'
          if (yEl && yEl.style) yEl.style.display = 'inline-block'
        }
      }

      function getSamples () {
        const data = []

        const HOURS = 1000 * 60 * 60
        const INTERVAL = 48

        let now = Date.now()
        for (let i = 0; i < 30; i++) {
          const time = new Date(now)
          const value = Math.random() * 10 + 5
          data.push([time, value])
          now += Math.random() * HOURS * INTERVAL + HOURS * INTERVAL / 1.2
        }

        return data
      }

      function drawData (data) {
        if (!Array.isArray(data)) return alert('<data> must be an array')

        drawOnChart(chartEl, data)
        drawOnTable(tableEl, data)
        drawOnData(datasetEl, data)
      }

      function drawOnData (datasetEl, data) {
        datasetEl.innerText = JSON.stringify(data, null, 2)
      }
      function drawOnTable (tableEl, data) {
        tableEl.innerHTML = `<tr>
            <th>time</th>
            <th>value</th>
          </tr>`
        data.forEach(sample => {
          if (!sample[0]) return
          console.log('sample[0]', sample[0])
          const trEl = document.createElement('tr')
          trEl.innerHTML = `
            <td>
            ${new Date(sample[0]).toISOString()}
            </td>
            <td>
            ${sample[1]}
            </td>
          `
          tableEl.appendChild(trEl)
        })
      }

      function drawOnChart (chartEl, data) {
        const options = {
          title: 'value',
          interpolateNulls: true,
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Value',
            direction: 'r'
          },
          height: 300,
          width: 1200,
          legend: {position: 'none'}
        }

        var chart = new google.visualization.LineChart(chartEl)
        let chartData = google.visualization.arrayToDataTable([['time', 'value']].concat(data.map(i => [new Date(i[0]), i[1]])), false)
        chart.draw(chartData, options)
      }

      function handleFileSelect(evt) {
        var files = evt.target.files
        if (files.length < 1) throw new Error('please provide file')
        const file = files[0]
        var reader = new FileReader()

        reader.onload = handleFileRead

        reader.readAsText(file)
      }

      function handleFileRead(e) {
        let json = JSON.parse(e.target.result)
        drawData(json)
        if (selectedFileEl && selectedFileEl.style) selectedFileEl.style.display = 'none'
      }
    </script>
  </body>
</html>